<!DOCTYPE html>
<html>
<head> 
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="stylesheet.css">
	<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css" type="text/css">
	<script type="text/javascript">

	window.addEventListener("load", initialize);
	var correlation_worker = new Worker("correlation_worker.js");
	correlation_worker.addEventListener("message", interpret_correlation_result);

	//variable declarations
	var fft_size = 2048;	
	var frequency_buffer = new Float32Array(fft_size);


	//initialize access to microphone 
	function initialize(){

		var getMicrophone = navigator.getUserMedia;
		getMicrophone = getMicrophone || navigator. webkitGetUserMedia || navigator. mozGetUserMedia;
		//moz for firefox and webkit for crome and others 

		getMicrophone.call(navigator, {"audio": true}, use_stream, function() {});

	}


	//input parameter stream since it's the microphone
	function use_stream (stream){

		var audio_context = new AudioContext();
		var mic = audio_context.createMediaStreamSource(stream);
		//creates a node with a mediastream representing the microphone 
		
		//creates an analyzer node
		var analyser = audio_context.createAnalyser();
		var gain_node = audio_context.createGain();

		gain_node.gain.value = 0;


		analyser.fftSize = 2048;

		mic.connect(analyser);
		analyser.connect(gain_node);
		gain_node.connect(audio_context.destination);

	}

	function interpret_correlation_result ( event ) {

	console.log("inne i interpret");

		//reach timeseries (periods)
		var period = event.data.period;
		var frequency_amplitudes = event.data.frequency_amplitudes;
		var searchSize = fft_size*0.5;

		//fill up buffer with data from getFloatTimeDomain(the wave with values between one and minus one)
		analyser.getFloatTimeDomainData(frequency_buffer);

		//compute the squared magnitudes of the comples amplitudes for each test freq. 
		var magnitudes = frequency_amplitudes.map(function(z){return z[0] * z[0] + z[1] * z[1]; })
	}
	</script>
</head>

<body>

	<div class ="col-12">
	<p id = "title"> GUITAR TUNER  <sub><i class="fa fa-music"></i></sub></p>
	<hr class = "default">
	<p id = "about"> 
	A Guitar Tuner made for the course TFYA65 at Linköping University <br>
	Made by Kristin Bäck, Karin Reidarman, Sara Martin.
	</p>
	
	<p id = "tones"> </p>

	<div class ="col-4 down">
	<i id = "icon-down" class="fa fa-3x fa-chevron-down text-default"></i>
	</div>
	<div class ="col-4">
	<canvas id = "myCanvas" width = "100" height = "100"> 
	</canvas> 
	</div>
	<div class ="col-4 up">
	<i id = "icon-up" class="fa fa-3x fa-chevron-up text-default"></i> 
	</div>

	<br>
	
	<button onclick="currentTone(0, 10)">E</button>
	<button onclick="currentTone(1, 20)">A</button>
	<button onclick="currentTone(2, 10)">D</button>
	<button onclick="currentTone(3)">G</button>
	<button onclick="currentTone(4)">B</button>
	<button onclick="currentTone(5)">E</button>
	
	<p id = "about"> Current Frequency: </p>
	<p id ="currFreq"> </p>

	</div>

	<!-- Script part of UI -->
	<script>
	var tones = ["E", "A", "D", "G", "B", "E"];
	var text = "";
	var i;
	for(i = 0; i < 6; i++)
	{
		text += tones[i] + " ";
	}

	var c = document.getElementById("myCanvas");
	var ctx = c.getContext("2d");
	ctx.font = "40px Arial";
	ctx.fillStyle = "#FF4719";

	
	function currentTone(tone, freq) 
	{
		document.getElementById("icon-up").style.color = "#a9a9a9";
		document.getElementById("icon-down").style.color = "#a9a9a9";
		if(freq > 10)
		{
			document.getElementById("icon-up").style.color = "#313131";
		}
		else
		{
			document.getElementById("icon-down").style.color = "#313131";
		}
		for(var i = 0; i < 6; i++)
		{
			if(tone == i)
			{
				ctx.clearRect(0, 0, 100, c.height);
				ctx.fillText(tones[i], 36, 60);
				break;
			}
		}

		document.getElementById("currFreq").innerHTML = tone;
		
	}
	</script>
	
</body>

</html>

