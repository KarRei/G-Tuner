<!DOCTYPE html>
<html>
<head> 
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="stylesheet.css">
	<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css" type="text/css">
	<script type="text/javascript">
	//Projekt G-Tunder

	console.log("first");

	//variable declarations
	var fft_size = 2048;	
	var frequency_buffer = new Float32Array(fft_size);
	var audio_context = new AudioContext();
	var analyser = audio_context.createAnalyser();

	var C2 = 65.41; // C2 note, in Hz.
	var notes = [ "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" ];
	var test_frequencies = [];
	for (var i = 0; i < 30; i++)
	{
		var note_frequency = C2 * Math.pow(2, i / 12);
		var note_name = notes[i % 12];
		var note = { "frequency": note_frequency, "name": note_name };
		var just_above = { "frequency": note_frequency * Math.pow(2, 1 / 48), "name": note_name + " (a bit sharp)" };
		var just_below = { "frequency": note_frequency * Math.pow(2, -1 / 48), "name": note_name + " (a bit flat)" };
		test_frequencies = test_frequencies.concat([ just_below, note, just_above ]);
	}

console.log(note_frequency);


	window.addEventListener("load", initialize);
	var correlation_worker = new Worker("correlation_worker.js");
	correlation_worker.addEventListener("message", interpret_correlation_result);


	//initialize access to microphone 
	function initialize(){

		console.log("inne i initialize");

		var getMicrophone = navigator.getUserMedia;
		getMicrophone = getMicrophone || navigator. webkitGetUserMedia || navigator. mozGetUserMedia;
		//moz for firefox and webkit for crome and others 

		getMicrophone.call(navigator, {"audio": true}, use_stream, function() {});

	}




	//input parameter stream since it's the microphone
	function use_stream (stream){

		console.log("inne i use_stream");
		analyser.fftSize = fft_size;

		var mic = audio_context.createMediaStreamSource(stream);
		var gain_node = audio_context.createGain();
		

		gain_node.gain.value = 0;

		mic.connect(analyser);
		analyser.connect(gain_node);
		gain_node.connect(audio_context.destination);

	
		//load in buffer

		loop();
	

	}

	function loop(){

		var buffer = new Float32Array(analyser.fftSize);
		analyser.getFloatTimeDomainData(buffer);
		console.log(buffer);


		correlation_worker.postMessage({

			"timeseries": Array.prototype.slice.call(buffer), "test_frequencies": test_frequencies, "sample_rate": audio_context.sampleRate

		});

	}



	function interpret_correlation_result (event) {

	console.log("inne i interpret");

		var timeseries = event.data.timeseries;
		var frequency_amplitudes = event.data.frequency_amplitudes;


		// Compute the (squared) magnitudes of the complex amplitudes for each
		// test frequency.
		var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });

		// Find the maximum in the list of magnitudes.
		var maximum_index = -1;
		var maximum_magnitude = 0;
		for (var i = 0; i < magnitudes.length; i++)
		{
			if (magnitudes[i] <= maximum_magnitude)
				continue;
			maximum_index = i;
			maximum_magnitude = magnitudes[i];
		}

		// Compute the average magnitude. We'll only pay attention to frequencies
		// with magnitudes significantly above average.
		var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
		var confidence = maximum_magnitude / average;
		var confidence_threshold = 10; // empirical, arbitrary.
		if (confidence > confidence_threshold)
		{
			console.log("inne i confidence");
			var dominant_frequency = test_frequencies[maximum_index];
			setData(dominant_frequency.name, dominant_frequency.frequency);
		}
		setTimeout(loop, 250);

	}	


	function setData(namn, freq)
	{
	var c = document.getElementById("myCanvas");
	var ctx = c.getContext("2d");
	ctx.font = "40px Arial";
	ctx.fillStyle = "#FF4719";

	ctx.clearRect(0, 0, 300, c.height);
	ctx.fillText(namn, 36, 60);

	document.getElementById("currFreq").innerHTML = freq;
	}
	
	
	</script>
</head>

<body>
	<p id = "title"> GUITAR TUNER  <sub><i class="fa fa-music"></i></sub></p>
	<hr class = "default">
	<p id = "about"> 
	A Guitar Tuner made for the course TFYA65 at Linköping University <br>
	Made by Kristin Bäck, Karin Reidarman, Sara Martin
	</p>
	<i id = "icon-down" class="fa fa-1x fa-caret-left text-default"></i>
	<i id = "icon-down" class="fa fa-2x fa-caret-left text-default"></i>
	<i id = "icon-down" class="fa fa-3x fa-caret-left text-default"></i>

	<canvas id = "myCanvas" width = "300" height = "100"> 
	</canvas> 
	<i id = "icon-up" class="fa fa-3x fa-caret-right text-default"></i> 
	<i id = "icon-up" class="fa fa-2x fa-caret-right text-default"></i> 
	<i id = "icon-up" class="fa fa-1x fa-caret-right text-default"></i> 
	<br>
	<p id = "about"> Current Frequency: </p>
	<p id ="currFreq"> </p>

	
</body>

</html>

