<!DOCTYPE html>
<html>
<head> 
	<meta charset="utf-8"/>
	<link rel="stylesheet" href="css\stylesheet.css">
	<script type="text/javascript">


	console.log("first");

	//variable declarations
	var fft_size = 2048;	
	var frequency_buffer = new Float32Array(fft_size);
	var audio_context = new AudioContext();
	var analyser = audio_context.createAnalyser();

	var C2 = 65.41; // C2 note, in Hz.
	var notes = [ "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" ];
	var test_frequencies = [];
	for (var i = 0; i < 30; i++)
	{
		var note_frequency = C2 * Math.pow(2, i / 12);
		var note_name = notes[i % 12];
		var note = { "frequency": note_frequency, "name": note_name };
		var just_above = { "frequency": note_frequency * Math.pow(2, 1 / 48), "name": note_name + " (a bit sharp)" };
		var just_below = { "frequency": note_frequency * Math.pow(2, -1 / 48), "name": note_name + " (a bit flat)" };
		test_frequencies = test_frequencies.concat([ just_below, note, just_above ]);
	}



	window.addEventListener("load", initialize);
	var correlation_worker = new Worker("correlation_worker.js");
	correlation_worker.addEventListener("message", interpret_correlation_result);


	//initialize access to microphone 
	function initialize(){

		console.log("inne i initialize");

		var getMicrophone = navigator.getUserMedia;
		getMicrophone = getMicrophone || navigator. webkitGetUserMedia || navigator. mozGetUserMedia;
		//moz for firefox and webkit for crome and others 

		getMicrophone.call(navigator, {"audio": true}, use_stream, function() {});

	}




	//input parameter stream since it's the microphone
	function use_stream (stream){

		console.log("inne i use_stream");

		var mic = audio_context.createMediaStreamSource(stream);
		//creates a node with a mediastream representing the microphone 
		
		//creates an analyzer node
		
		var gain_node = audio_context.createGain();
		var buffer = new Float32Array(fft_size);

		gain_node.gain.value = 0;


		analyser.fftSize = 2048;

		mic.connect(analyser);
		analyser.connect(gain_node);
		gain_node.connect(audio_context.destination);


		//load in buffer
		analyser.getFloatTimeDomainData(buffer);

		correlation_worker.postMessage({

			"timeseries": buffer, "test_frequencies": test_frequencies, "sample_rate": audio_context.sampleRate

		});


	}



	function interpret_correlation_result (event) {

	console.log("inne i interpret");

		var timeseries = event.data.timeseries;
		var frequency_amplitudes = event.data.frequency_amplitudes;


		//fill up buffer with data from getFloatTimeDomain(the wave with values between one and minus one)
		analyser.getFloatTimeDomainData(frequency_buffer);




	}	

	</script>
</head>

<body>

	<h1> Welcome to our awesome G-Tuner </h1>



	

	<script src="js\g_tuner.js"> </script>
	
</body>

</html>